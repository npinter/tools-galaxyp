<tool id="diann" name="DIA-NN" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>is a software for DIA/SWATH data processing</description>
    <macros>
        <token name="@TOOL_VERSION@">2.0.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements>
        <container type="docker">diann:@TOOL_VERSION@</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        mkdir ./input_data &&
        mkdir ./tmp &&

        ## generate string like "--f file1 --f file2 ..." for each input in $input.f, which are comma separated
        #set infiles_str = ''
        #for $infile in $input.f
            ## if brukertdf.d.tar, extract to ./input_data and append "./input_data/" to infiles_str
            #if $infile.is_of_type("brukertdf.d.tar"):
                tar -xf '$infile' -C ./input_data &&
                #set $infiles_str += '--f ./input_data/' + str($infile.element_identifier[:-4]) + ' '
            #else
		#if $input.spectral_lib_options.gen_spec_lib != "--gen-spec-lib"
                	ln -s '$infile' './input_data/$infile.element_identifier' &&
                	#set $infiles_str += '--f ./input_data/' + str($infile.element_identifier)
		#end if
            #end if
        #end for

        #set $fasta_file_str = ''
        #for $fasta_file in $input.fasta_db_options.fasta
            #set $fasta_file_str += '--fasta ' + str($fasta_file) + ' '
        #end for

        #if $input.spectral_lib_options.lib
            ln -s '$input.spectral_lib_options.lib' './input_data/report-lib.predicted.speclib' &&
        #end if

        diann \
            #if $infiles_str != "--f None "
            '$infiles_str' \
            #end if
            --dir './' \
            --threads '${GALAXY_SLOTS:-1}' \
            --temp './tmp' \

            ## ---------- Spectral library / generation ----------
            #if $input.spectral_lib_options.gen_spec_lib == "True"
            --gen-spec-lib \
            --out-lib './report-lib.speclib' \
            #else
            --out './report.tsv' \
            #end if

            #if $input.spectral_lib_options.lib
            --lib './input_data/report-lib.predicted.speclib' \
            #end if

            #if $input.spectral_lib_options.library_headers and $input.spectral_lib_options.library_headers != "None"
            --library-headers '$input.spectral_lib_options.library_headers' \
            #end if

            #if $input.spectral_lib_options.no_lib_filter
            --no-lib-filter \
            #end if

            #if $input.spectral_lib_options.learn_lib
            --learn-lib '$input.spectral_lib_options.learn_lib' \
            #end if

            #if $input.spectral_lib_options.out_measured_rt
            --out-measured-rt \
            #end if

            #if $input.spectral_lib_options.predictor
            --predictor \
            #end if

            #if $input.spectral_lib_options.reannotate
            --reannotate \
            #end if

            ## (Experimental) reference library for calibration
            ##if $input.spectral_lib_options.ref
            ## --ref file \
            ##end if

            ## ---------- FASTA database options ----------
            #if $fasta_file_str != ''
            '$fasta_file_str' \
            #end if

            #if $input.fasta_db_options.fasta_filter
            --fasta-filter '$input.fasta_db_options.fasta_filter' \
            #end if

            #if $input.fasta_db_options.fasta_search
            --fasta-search \
            #end if

            ## ---------- Analysis/Scoring mode ----------
            #if $analysis_mode.analysis_mode
            '$analysis_mode.analysis_mode' \
            #end if

            ## ---------- Algorithm / Calibration ----------
            #if $algo_options.no_calibration
            --no-calibration \
            #end if

            #if $algo_options.mass_acc
            --mass-acc '$algo_options.mass_acc' \
            #end if

            #if $algo_options.mass_acc_cal
            --mass-acc-cal '$algo_options.mass_acc_cal' \
            #end if

            #if $algo_options.mass_acc_ms1
            --mass-acc-ms1 '$algo_options.mass_acc_ms1' \
            #end if

            # (Experimental) fast heuristical algorithm for MS2 mass accuracy
            ##if $algo_options.quick_mass_acc
            ##--quick-mass-acc \
            ##end if

            #if $algo_options.reanalyse
            --reanalyse \
            #end if

            #if $algo_options.mbr_fix_settings
            --mbr-fix-settings \
            #end if

            #if $algo_options.relaxed_prot_inf
            --relaxed-prot-inf \
            #end if

            '$algo_options.prot_inf' \
            '$algo_options.nn_classifier' \
            '$algo_options.quant_engine' \
            '$algo_options.cross_run_norm' \

            #if $algo_options.lib_gen_strategy
            '$algo_options.lib_gen_strategy' \
            #end if

            ## ---------- Additional calibration/ML options ----------
            #if $algo_options.cal_mode
            --cal '$algo_options.cal_mode' \
            #end if

            #if $algo_options.time_corr_only
            --time-corr-only \
            #end if

            #if $algo_options.time_corr_only_force
            --time-corr-only-force \
            #end if

            #if $algo_options.no_batch_mode
            --no-batch-mode \
            #end if

            ## ---------- Ion mobility window ----------
            #if $im_window_options.no_im_window
            --no-im-window \
            #end if

            #if $im_window_options.window
            --window '$im_window_options.window' \
            #end if

            #if $im_window_options.im_window
            --im-window '$im_window_options.im_window' \
            #end if

            #if $im_window_options.im_window_factor
            --im-window-factor '$im_window_options.im_window_factor' \
            #end if

            ## ---------- Precursor/cleavage options ----------
            --cut '$precursor_options.cleavage_spec.cut' \
            --missed-cleavages '$precursor_options.missed_cleavages' \

            #if $precursor_options.met_excision
            --met-excision \
            #end if

            --min-pep-len '$precursor_options.min_pep_len' \
            --max-pep-len '$precursor_options.max_pep_len' \
            --min-pr-mz '$precursor_options.min_pr_mz' \
            --max-pr-mz '$precursor_options.max_pr_mz' \
            --min-pr-charge '$precursor_options.min_pr_charge' \
            --max-pr-charge '$precursor_options.max_pr_charge' \
            --min-fr-mz '$precursor_options.min_fr_mz' \
            --max-fr-mz '$precursor_options.max_fr_mz' \

            #if $precursor_options.nn_single_seq
            --nn-single-seq \
            #end if

            #if $precursor_options.int_removal
            --int-removal '$precursor_options.int_removal' \
            #end if

            ## ---------- Modifications ----------
            #if $mod_options.clear_mods
            --clear-mods \
            #end if

            #if $mod_options.fixed_mod
            --fixed-mod '$mod_options.fixed_mod' \
            #end if

            #if $mod_options.var_mod
            --var-mod '$mod_options.var_mod' \
            #end if

            #if $mod_options.var_mods
            --var-mods '$mod_options.var_mods' \
            #end if

            #if $mod_options.mod
            --mod '$mod_options.mod' \
            #end if

            #if $mod_options.monitor_mod
            --monitor-mod '$mod_options.monitor_mod' \
            #end if

            #if $mod_options.no_cut_after_mod
            --no-cut-after-mod '$mod_options.no_cut_after_mod' \
            #end if

            #if $mod_options.original_mods
            --original-mods \
            #end if

            #if $mod_options.lib_fixed_mod
            --lib-fixed-mod '$mod_options.lib_fixed_mod' \
            #end if

            #if $mod_options.mod_only
            --mod-only \
            #end if

            #if $mod_options.strip_unknown_mods
            --strip-unknown-mods \
            #end if

            #if $mod_options.full_unimod
            --full-unimod \
            #end if

            #if $mod_options.unimod4
            --unimod4 \
            #end if

            #if $mod_options.unimod35
            --unimod35 \
            #end if

            ## ---------- Channel / multiplexing ----------
            #if $channel_options.channels
            --channels '$channel_options.channels' \
            #end if

            #if $channel_options.decoy_channel
            --decoy-channel '$channel_options.decoy_channel' \
            #end if

            #if $channel_options.no_decoy_channel
            --no-decoy-channel \
            #end if

            #if $channel_options.channel_run_norm
            --channel-run-norm \
            #end if

            #if $channel_options.channel_spec_norm
            --channel-spec-norm \
            #end if

            ## ---------- Fragmentation / quantification ----------
            #if $mass_frag_options.no_fr_selection
            --no-fr-selection \
            #end if

            #if $mass_frag_options.quant_fr
            --quant-fr '$mass_frag_options.quant_fr' \
            #end if

            #if $mass_frag_options.restrict_fr
            --restrict-fr \
            #end if

            #if $mass_frag_options.sptxt_acc
            --sptxt-acc '$mass_frag_options.sptxt_acc' \
            #end if

            #if $mass_frag_options.target_fr
            --target-fr '$mass_frag_options.target_fr' \
            #end if

            ## ---------- Quantification / MBR ----------
            #if $quantification_options.peak_translation
            --peak-translation \
            #end if

            #if $quantification_options.no_maxlfq
            --no-maxlfq \
            #end if

            ## ---------- Other / advanced options ----------
            #if $other_options.min_peak
            --min-peak '$other_options.min_peak' \
            #end if

            #if $other_options.no_rt_window
            --no-rt-window \
            #end if

            #if $other_options.no_stratification
            --no-stratification \
            #end if

            #if $other_options.no_swissprot
            --no-swissprot \
            #end if

            #if $other_options.dl_no_im
            --dl-no-im \
            #end if

            #if $other_options.dl_no_rt
            --dl-no-rt \
            #end if

            #if $other_options.duplicate_proteins
            --duplicate-proteins \
            #end if

            #if $other_options.exact_fdr
            --exact-fdr \
            #end if

            #if $other_options.force_swissprot
            --force-swissprot \
            #end if

            #if $other_options.gen_fr_restriction
            --gen-fr-restriction \
            #end if

            #if $other_options.global_mass_cal
            --global-mass-cal \
            #end if

            #if $other_options.individual_mass_acc
            --individual-mass-acc \
            #end if

            #if $other_options.individual_windows
            --individual-windows \
            #end if

            #if $other_options.no_isotopes
            --no-isotopes \
            #end if

            #if $other_options.regular_swath
            --regular-swath \
            #end if

            #if $other_options.scanning_swath
            --scanning-swath \
            #end if

            #if $other_options.species_genes
            --species-genes \
            #end if

            #if $other_options.tims_skip_errors
            --tims-skip-errors \
            #end if

            #if $other_options.semi
            --semi \
            #end if

            #if $other_options.il_eq
            --il-eq \
            #end if

            #if $other_options.cont_quant_exclude
            --cont-quant-exclude '$other_options.cont_quant_exclude' \
            #end if

            #if $other_options.dg_keep_nterm
            --dg-keep-nterm '$other_options.dg_keep_nterm' \
            #end if

            #if $other_options.dg_keep_cterm
            --dg-keep-cterm '$other_options.dg_keep_cterm' \
            #end if

            #if $other_options.dg_min_shuffle
            --dg-min-shuffle '$other_options.dg_min_shuffle' \
            #end if

            #if $other_options.dg_min_mut
            --dg-min-mut '$other_options.dg_min_mut' \
            #end if

            #if $other_options.dg_max_mut
            --dg-max-mut '$other_options.dg_max_mut' \
            #end if

            #if $other_options.dl_no_fr
            --dl-no-fr \
            #end if

            #if $other_options.export_quant
            --export-quant \
            #end if

            #if $other_options.ext_string
            --ext '$other_options.ext_string' \
            #end if

            #if $other_options.ids_to_names
            --ids-to-names \
            #end if

            #if $other_options.full_profiling
            --full-profiling \
            #end if

            #if $other_options.id_profiling
            --id-profiling \
            #end if

            #if $other_options.peak_boundary
            --peak-boundary '$other_options.peak_boundary' \
            #end if

            #if $other_options.min_cal
            --min-cal '$other_options.min_cal' \
            #end if

            #if $other_options.min_class
            --min-class '$other_options.min_class' \
            #end if

            #if $other_options.min_corr
            --min-corr '$other_options.min_corr' \
            #end if

            #if $other_options.no_fragmentation
            --no-fragmentation \
            #end if

            #if $other_options.no_ms1
            --no-ms1 \
            #end if

            #if $other_options.no_peptidoforms
            --no-peptidoforms \
            #end if

            #if $other_options.no_quant_files
            --no-quant-files \
            #end if

            #if $other_options.no_rt_norm
            --no-rt-norm \
            #end if

            #if $other_options.predict_n_frag
            --predict-n-frag '$other_options.predict_n_frag' \
            #end if

            #if $other_options.prefix_string
            --prefix '$other_options.prefix_string' \
            #end if

            #if $other_options.pr_filter
            --pr-filter '$other_options.pr_filter' \
            #end if

            #if $other_options.quant_acc
            --quant-acc '$other_options.quant_acc' \
            #end if

            #if $other_options.quant_no_ms1
            --quant-no-ms1 \
            #end if

            #if $other_options.quant_ori_names
            --quant-ori-names \
            #end if

            #if $other_options.quant_params
            --quant-params '$other_options.quant_params' \
            #end if

            #if $other_options.tims_min_int
            --tims-min-int '$other_options.tims_min_int' \
            #end if

            #if $other_options.tims_ms1_cycle
            --tims-ms1-cycle '$other_options.tims_ms1_cycle' \
            #end if

            #if $other_options.tokens_file
            --tokens '$other_options.tokens_file' \
            #end if

            #if $other_options.top_n
            --top '$other_options.top_n' \
            #end if

            #if $other_options.tune_im
            --tune-im \
            #end if

            #if $other_options.tune_rt
            --tune-rt \
            #end if

            #if $other_options.tune_lib
            --tune-lib '$other_options.tune_lib' \
            #end if

            #if $other_options.tune_lr
            --tune-lr '$other_options.tune_lr' \
            #end if

            #if $other_options.tune_restrict_layers
            --tune-restrict-layers \
            #end if

            ## ---------- Output and reporting ----------
            #if $output_options.no_main_report
            --no-main-report \
            #end if

            #if $output_options.individual_reports
            --individual-reports \
            #end if

            #if $output_options.no_stats
            --no-stats \
            #end if

            #if $output_options.compact_report
            --compact-report \
            #end if

            #if $output_options.matrices
            --matrices \
            #end if

            #if $output_options.report_decoys
            --report-decoys \
            #end if

            #if $output_options.matrix_ch_qvalue
            --matrix-ch-qvalue '$output_options.matrix_ch_qvalue' \
            #end if

            --qvalue '$output_options.qvalue' \

            #if $output_options.matrix_tr_qvalue
            --matrix-qvalue '$output_options.matrix_tr_qvalue' \
            #end if

            #if $output_options.matrix_spec_q
            --matrix-spec-q \
            #end if

            #if $output_options.report_lib_info
            --report-lib-info \
            #end if

            #if $output_options.vis
            --vis '$output_options.vis' \
            #end if

            --verbose '$output_options.verbose' \

        #if $input.f != "None"
            #if $output_options.no_main_report != "--no-main-report"
        && cp './report.tsv' '$output_report'
            #end if
        && cp './report.parquet' '$output_report_parquet'
        #end if

        #if $input.spectral_lib_options.gen_spec_lib == "True"
        && cp './report-lib.speclib' '$output_report_pred_speclib'
        #end if
    ]]></command>
    <inputs>
        <section name="input" expanded="true" title="Input files">
            <param name="f" type="data" format="mzml,dia,wiff,thermo.raw,brukertdf.d.tar" multiple="true" optional="true"
                   label="Input file(s)"
                   help="Specify one or more DIA/SWATH runs to be analysed. If using .d tar archives (Bruker), they are extracted automatically." />

            <!-- Spectral library section -->
            <section name="spectral_lib_options" title="Spectral library">
                <param name="gen_spec_lib" type="boolean" truevalue="True" falsevalue="False" checked="false"
                       label="Generate a spectral library (--gen-spec-lib)"
                       help="Instructs DIA-NN to generate a spectral library from DIA data (instead of performing standard analysis)."/>
                <param name="predictor" type="boolean" truevalue="--predictor" falsevalue="" checked="false"
                       label="Deep learning-based prediction of spectra, RT, IM"
                       help="Enable the neural predictor for library generation or library-free searches (predicts RT, IM, and fragment intensities)."/>
                <param name="lib" type="data" format="csv,tsv,xls,txt,binary,speclib,parquet" optional="true"
                       label="Spectral library file"
                       help="An existing spectral library (.speclib, .tsv, .csv, .txt, .parquet, etc.)"/>
                <param name="library_headers" type="text" optional="true"
                       label="Custom library headers"
                       help="Specifies column names in the library to be used, e.g. [name 1],[name 2],..., or '*' for auto-detection."/>
                <param name="no_lib_filter" type="boolean" truevalue="--no-lib-filter" falsevalue="" checked="false"
                       label="Use the input library as-is"
                       help="Prevents DIA-NN from discarding potentially suboptimal fragments or entries from the library."/>
                <param name="learn_lib" type="data" format="tsv" optional="true"
                       label="Training library"
                       help="Specifies a 'training library' for the older legacy predictor (used only if the main predictor is off)."/>
                <param name="out_measured_rt" type="boolean" truevalue="--out-measured-rt" falsevalue="" checked="false"
                       label="Save raw empirical RT in library"
                       help="Save raw empirical RTs in the spectral library being generated (instead of aligning to a standard scale)."/>
                <param name="reannotate" type="boolean" truevalue="--reannotate" falsevalue="" checked="false"
                       label="Re-annotate library with FASTA"
                       help="Reannotate the spectral library using a FASTA database (requires the same cleavage rules)."/>
                <!-- Experimental:
                <param name="ref" type="text" optional="true" label="Reference library for calibration" />
                -->
            </section>

            <!-- FASTA database -->
            <section name="fasta_db_options" title="FASTA database">
                <param name="fasta" type="data" format="fasta" optional="true" multiple="true"
                       label="FASTA file(s)"
                       help="FASTA format sequence database(s). Use multiple if needed."/>
                <param name="fasta_filter" type="data" format="txt" optional="true"
                       label="FASTA filter"
                       help="A text file listing stripped peptide sequences (one per line). Only those peptides are considered."/>
                <param name="fasta_search" type="boolean" truevalue="--fasta-search" falsevalue="" checked="false"
                       label="Perform in silico digest"
                       help="Instruct DIA-NN to do an in silico digest of the specified FASTA database (library-free search)."/>
            </section>
        </section>

        <!-- ========== Algorithm/Analysis Options ========== -->
        <section name="analysis_mode" title="Analysis / Scoring Mode">
            <param name="analysis_mode" type="select"
                   label="Scoring mode (Generic / Peptidoforms / Proteoforms)"
                   help="Select the confidence scoring approach.">
                <option value="" selected="True">Generic (default)</option>
                <option value="--peptidoforms">Peptidoforms mode</option>
                <option value="--proteoforms">Proteoforms mode</option>
            </param>
        </section>

        <section name="algo_options" title="Algorithm and Calibration">
            <param name="no_calibration" type="boolean" truevalue="--no-calibration" falsevalue="" checked="false"
                   label="Disable mass calibration"
                   help="Disable the automatic mass calibration step (not recommended)."/>
            <param name="mass_acc" type="float" min="0" optional="true"
                   label="MS2 mass accuracy (ppm)"
                   help="Sets a fixed MS2 mass accuracy (ppm). E.g. 20."/>
            <param name="mass_acc_cal" type="float" min="0" optional="true"
                   label="Calibration-phase mass accuracy (ppm)"
                   help="Sets the mass accuracy used during calibration (default ~100 ppm)."/>
            <param name="mass_acc_ms1" type="float" min="0" optional="true"
                   label="MS1 mass accuracy (ppm)"
                   help="Sets the MS1 mass accuracy (ppm). E.g. 20."/>
            <!--
            <param name="quick_mass_acc" type="boolean" truevalue="--><!--quick-mass-acc" falsevalue="" checked="false"
                   label="(Experimental) Quick heuristics for mass accuracy"
                   help="When determining MS2 mass accuracy automatically, uses a faster heuristic approach instead of maximizing IDs."/>
            -->
            <param name="reanalyse" type="boolean" truevalue="--reanalyse" falsevalue="" checked="false"
                   label="Enable MBR"
                   help="Turns on the 'match between runs' functionality in DIA-NN."/>
            <param name="mbr_fix_settings" type="boolean" truevalue="--mbr-fix-settings" falsevalue="" checked="false"
                   label="MBR fix settings"
                   help="When using 'Unrelated runs' + MBR, use the same settings for all runs in the second pass."/>
            <param name="relaxed_prot_inf" type="boolean" truevalue="--relaxed-prot-inf" falsevalue="" checked="true"
                   label="Use a very heuristical protein inference"
                   help="Equivalent to the 'Heuristic protein inference' in the DIA-NN GUI. Not recommended for typical differential expression analyses."/>
            <param name="prot_inf" type="select"
                   label="Proteotypicity"
                   help="Controls how DIA-NN groups proteins. 'Off' uses library protein grouping as-is.">
                <option value="--pg-level 0">Isoform IDs (pg-level 0)</option>
                <option value="--pg-level 1">Protein names (pg-level 1)</option>
                <option value="--pg-level 2" selected="True">Genes (pg-level 2)</option>
                <option value="--no-prot-inf">Off (no grouping)</option>
            </param>
            <param name="nn_classifier" type="select"
                   label="Neural network classifier"
                   help="Single-pass is default. Double-pass is slower but often yields more IDs. 'Conservative' is also available.">
                <option value="" selected="True">Single-pass mode</option>
                <option value="--conservative">Conservative mode</option>
                <option value="--double-search">Double-pass mode</option>
                <option value="--no-nn">Off</option>
            </param>
            <param name="quant_engine" type="select"
                   label="Quantification engine"
                   help="Choose between QuantUMS (high precision or high accuracy) or older direct quant.">
                <option value="">QuantUMS (high precision)</option>
                <option value="--high-acc">QuantUMS (high accuracy)</option>
                <option value="--direct-quant">Legacy direct quant</option>
            </param>
            <param name="cross_run_norm" type="select"
                   label="Cross-run normalisation"
                   help="Choose how DIA-NN performs cross-run normalisation of intensities.">
                <option value="--global-norm">Global (simple global normalisation)</option>
                <option value="">RT-dependent (default)</option>
                <option value="--sig-norm">signal-dep normalisation (not recommended)</option>
                <option value="--no-norm">Off</option>
            </param>
            <param name="lib_gen_strategy" type="select"
                   label="Library generation strategy"
                   help="If generating a library from DIA data, choose how to extract spectra. 'Smart profiling' is usually recommended.">
                <option value="--id-profiling">IDs profiling</option>
                <option value="--rt-profiling">IDs, RT and IM profiling</option>
                <option value="--smart-profiling" selected="true">Smart profiling (recommended)</option>
                <option value="">Full profiling</option>
            </param>

            <param name="cal_mode" type="select"
                   label="Calibration mode"
                   help="Choose the DIA-NN calibration mode. Valid values: 0 (off), 1, 3, 5, or 7 (default 7)">
                <option value="0">0 (off)</option>
                <option value="1">1</option>
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="7" selected="true">7 (default)</option>
            </param>

            <param name="time_corr_only" type="boolean" truevalue="--time-corr-only" falsevalue=""
                   checked="false" label="Time correlation only"
                   help="Restrict machine learning during calibration to time correlation only." />

            <param name="time_corr_only_force" type="boolean" truevalue="--time-corr-only-force" falsevalue=""
                   checked="false" label="Force time correlation only"
                   help="Restrict the use of machine learning for peak group selection during all search stages." />

            <param name="no_batch_mode" type="boolean" truevalue="--no-batch-mode" falsevalue=""
                   checked="false" label="Disable batch mode"
                   help="Use all precursors for calibration at once, instead of the default batch approach." />
        </section>

        <!-- ========== IM / Window Options ========== -->
        <section name="im_window_options" title="Ion Mobility / Scan Window">
            <param name="no_im_window" type="boolean" truevalue="--no-im-window" falsevalue="" checked="false"
                   label="Disable IM-windowed search"
                   help="Disable the use of ion mobility window constraints."/>
            <param name="window" type="integer" min="0" optional="true"
                   label="Scan window radius"
                   help="Set an explicit window radius for MS2 extraction (should match data density)."/>
            <param name="im_window" type="integer" min="0" optional="true"
                   label="IM extraction window"
                   help="Fix the IM extraction window to this value (disables auto)."/>
            <param name="im_window_factor" type="float" min="0" value="2.0"
                   label="IM extraction window factor"
                   help="Multiplier controlling minimal IM extraction window size (default 2.0)."/>
        </section>

        <!-- ========== Precursor / Cleavage Options ========== -->
        <section name="precursor_options" title="Precursor Ion Generation">
            <conditional name="cleavage_spec">
                <param name="cut_type" type="select" label="Cleavage specificity">
                    <option value="predefined">Predefined pattern (enzyme)</option>
                    <option value="non_specific">Non-specific cleavage</option>
                    <option value="own">User-defined pattern</option>
                </param>
                <when value="predefined">
                    <param name="cut" type="select" label="Protease"
                           help="Common cleavage patterns. For example, K*,R*,!*P for canonical trypsin excluding cuts before P.">
                        <option value="K*,R*" selected="true">Trypsin/P (K*,R*)</option>
                        <option value="K*,R*,!*P">Trypsin (K*,R*,!*P)</option>
                        <option value="K*">Lys-C/P (K*)</option>
                        <option value="K*,!*P">Lys-C (K*,!*P)</option>
                        <option value="F*,Y*,W*,L*,!*P">Chymotrypsin (F*,Y*,W*,L*,!*P)</option>
                        <option value="*D">AspN (*D)</option>
                        <option value="D*,E*,!*P">GluC (D*,E*,!*P)</option>
                    </param>
                </when>
                <when value="non_specific">
                    <param name="cut" type="text" label="Non-specific cut pattern" value="**"
                           help="Set to '**' for fully non-specific digest. You can still override if needed."/>
                </when>
                <when value="own">
                    <param name="cut" type="text" label="Custom cleavage pattern"
                           help="Comma-separated rules, e.g. K*,R*,!*P for typical trypsin. Cut before AA, e.g. *D"/>
                </when>
            </conditional>
            <param name="missed_cleavages" type="integer" min="0" max="100" value="1"
                   label="Max missed cleavages"
                   help="Sets the maximum number of missed cleavages. For non-specific set to 100."/>
            <param name="met_excision" type="boolean" truevalue="--met-excision" falsevalue="" checked="true"
                   label="Enable protein N-term methionine excision"
                   help="Add N-terminal M excision as a variable modification for in silico digest."/>
            <param name="min_pep_len" type="integer" min="5" max="100" value="7"
                   label="Minimum peptide length"
                   help="Discard any peptides shorter than this."/>
            <param name="max_pep_len" type="integer" min="5" max="100" value="30"
                   label="Maximum peptide length"
                   help="Discard any peptides longer than this."/>
            <param name="min_pr_mz" type="integer" min="0" value="300"
                   label="Min precursor m/z"
                   help="Lower limit for precursor m/z range to consider."/>
            <param name="max_pr_mz" type="integer" min="0" value="1800"
                   label="Max precursor m/z"
                   help="Upper limit for precursor m/z range."/>
            <param name="min_pr_charge" type="integer" min="1" max="10" value="1" optional="true"
                   label="Min precursor charge"
                   help="Lower bound for precursor charge state."/>
            <param name="max_pr_charge" type="integer" min="1" max="10" value="4"
                   label="Max precursor charge"
                   help="Upper bound for precursor charge state."/>
            <param name="min_fr_mz" type="integer" min="0" value="200"
                   label="Minimum fragment m/z"
                   help="Specifies the minimum fragment m/z to keep in the library."/>
            <param name="max_fr_mz" type="integer" min="0" value="1800"
                   label="Maximum fragment m/z"
                   help="Specifies the maximum fragment m/z to keep in the library."/>
            <param name="nn_single_seq" type="boolean" truevalue="--nn-single-seq" falsevalue="" checked="false"
                   label="Use one precursor per stripped sequence for NN training"
                   help="Only use the single best precursor per stripped sequence when training the neural network classifier."/>
            <param name="int_removal" type="integer" min="0" optional="true"
                   label="Interference removal"
                   help="Set to 0 to disable removing interfering precursors. By default, it is left blank so DIA-NN uses its default."/>
        </section>

        <!-- ========== Modifications ========== -->
        <section name="mod_options" title="Modifications">
            <param name="clear_mods" type="boolean" truevalue="--clear-mods" falsevalue="" checked="false"
                   label="Clear built-in modifications"
                   help="Make DIA-NN forget all built-in modification names."/>
            <param name="fixed_mod" type="text" optional="true"
                   label="Fixed modification (--fixed-mod)"
                   help="Syntax: [name],[mass],[sites],[optional:'label']. Example: Carbamidomethyl,57.021464,C."/>
            <param name="var_mod" type="text" optional="true"
                   label="Variable modification (--var-mod)"
                   help="Syntax: [name],[mass],[sites],[optional:'label']. E.g. UniMod:21,79.966331,STY for phosphorylation."/>
            <param name="var_mods" type="integer" min="0" optional="true"
                   label="Max number of variable mods"
                   help="Set the maximum number of variable modifications per peptide."/>
            <param name="mod" type="text" optional="true"
                   label="Custom modification name (--mod)"
                   help="Declares a new named modification. Syntax: [name],[mass],[optional:'label']."/>
            <param name="monitor_mod" type="text" optional="true"
                   label="Modification for PTM scoring/localisation (--monitor-mod)"
                   help="Apply PTM scoring and site localisation for the specified variable modification. Must be declared via --var-mod first."/>
            <param name="no_cut_after_mod" type="text" optional="true"
                   label="No cut after modification (--no-cut-after-mod)"
                   help="Discard peptides generated via cleavage after residues bearing a particular mod, e.g. SILAC-Lys8."/>
            <param name="original_mods" type="boolean" truevalue="--original-mods" falsevalue="" checked="false"
                   label="Disable automatic mod name conversion"
                   help="Disables the automatic conversion of known modifications into UniMod format."/>
            <param name="lib_fixed_mod" type="text" optional="true"
                   label="Apply a fixed mod to library (--lib-fixed-mod)"
                   help="In silico applies a declared fixed modification to the library. Must be declared with --fixed-mod first."/>
            <param name="mod_only" type="boolean" truevalue="--mod-only" falsevalue="" checked="false"
                   label="Only peptides with declared modifications"
                   help="Only consider peptides bearing modifications listed via --monitor-mod."/>
            <param name="strip_unknown_mods" type="boolean" truevalue="--strip-unknown-mods" falsevalue="" checked="false"
                   label="Ignore unknown modifications"
                   help="Any modifications not supported by the deep learning predictor will be removed from peptides."/>
            <param name="full_unimod" type="boolean" truevalue="--full-unimod" falsevalue="" checked="false"
                   label="Load entire UniMod DB"
                   help="Loads the complete UniMod modification database and disables automatic name conversion."/>
            <param name="unimod4" type="boolean" truevalue="--unimod4" falsevalue="" checked="true"
                   label="Include Carbamidomethyl (C, +57.021464)"
                   help="Convenience toggle for the widely used Cys alkylation."/>
            <param name="unimod35" type="boolean" truevalue="--unimod35" falsevalue="" checked="false"
                   label="Include Oxidation (M, +15.994915)"
                   help="Convenience toggle for common M oxidation."/>
        </section>

        <!-- ========== Fragmentation / Mass calibration ========== -->
        <section name="mass_frag_options" title="Fragmentation">
            <param name="no_fr_selection" type="boolean" truevalue="--no-fr-selection" falsevalue="" checked="false"
                   label="Disable fragment selection"
                   help="Skip fragment selection based on extracted chromatogram quality."/>
            <param name="quant_fr" type="integer" min="0" optional="true"
                   label="Number of top fragments for quant"
                   help="The number of top fragment ions to consider for quantification (legacy mode)."/>
            <param name="restrict_fr" type="boolean" truevalue="--restrict-fr" falsevalue="" checked="false"
                   label="Restrict fragments for quant"
                   help="Use ExcludeFromAssay column in the library to skip certain fragments from quantification."/>
            <param name="sptxt_acc" type="integer" min="0" optional="true"
                   label="Fragment filtering mass accuracy for .sptxt/.msp"
                   help="Used when reading sptxt/msp spectral libraries (experimental)."/>
            <param name="target_fr" type="integer" min="0" optional="true"
                   label="Number of fr ions in library"
                   help="Beyond this number, only fragments with high-quality chromatograms are included in the library created from DIA data."/>
        </section>

        <!-- ========== Channels (plexDIA / TMT / SILAC) ========== -->
        <section name="channel_options" title="Channels / Multiplexing">
            <param name="channels" type="text" optional="true"
                   label="Channels"
                   help="Syntax: [chan] = [label group],[chan name],[sites],[mass1:mass2:...] ; next channel ..."/>
            <param name="decoy_channel" type="text" optional="true"
                   label="Decoy channel masses (--decoy-channel)"
                   help="Specifies decoy channel mass shifts, syntax identical to --channels."/>
            <param name="no_decoy_channel" type="boolean" truevalue="--no-decoy-channel" falsevalue="" checked="false"
                   label="Disable decoy channel usage"
                   help="Disables the decoy channel approach for channel-level FDR."/>
            <param name="channel_run_norm" type="boolean" truevalue="--channel-run-norm" falsevalue=""
                   checked="false" label="Run-specific channel normalization"
                   help="Enable run-specific normalization for multiplexed samples, i.e. sum channels within each run, then normalize across runs." />
            <param name="channel_spec_norm" type="boolean" truevalue="--channel-spec-norm" falsevalue=""
                   checked="false" label="Channel-specific normalization"
                   help="Enable channel-specific normalization for multiplexed samples, treating each channel in each run as a separate sample for normalization." />
        </section>

        <!-- ========== Quantification Options ========== -->
        <section name="quantification_options" title="Quantification">
            <param name="peak_translation" type="boolean" truevalue="--peak-translation" falsevalue="" checked="false"
                   label="Leverage isotopologue co-elution (--peak-translation)"
                   help="Instruct DIA-NN to exploit co-elution of different isotopologues (e.g. heavy-labeled peptides)."/>
            <param name="no_maxlfq" type="boolean" truevalue="--no-maxlfq" falsevalue="" checked="false"
                   label="Disable MaxLFQ"
                   help="Use simpler protein quantity summation instead of MaxLFQ."/>
        </section>

        <!-- ========== Other / Advanced Options ========== -->
        <section name="other_options" title="Miscellaneous / Advanced">
            <param name="min_peak" type="float" min="0.01" optional="true"
                   label="Min peak height (--min-peak)"
                   help="Discard chromatographic peaks below this height. Default is typically 0.01."/>
            <param name="no_rt_window" type="boolean" truevalue="--no-rt-window" falsevalue="" checked="false"
                   label="Disable RT-windowed search"
                   help="Disable restricting MS2 extraction to an RT-based window around predicted RT."/>
            <param name="no_stratification" type="boolean" truevalue="--no-stratification" falsevalue="" checked="false"
                   label="Disable precursor stratification"
                   help="Turn off separate FDR control for PTMs (used if monitor-mod is set)."/>
            <param name="no_swissprot" type="boolean" truevalue="--no-swissprot" falsevalue="" checked="false"
                   label="Do not prefer SwissProt"
                   help="Prevent DIA-NN from giving preference to SwissProt entries in protein inference."/>
            <param name="dl_no_im" type="boolean" truevalue="--dl-no-im" falsevalue="" checked="false"
                   label="Disable IM prediction"
                   help="When using the predictor, skip ion mobility predictions."/>
            <param name="dl_no_rt" type="boolean" truevalue="--dl-no-rt" falsevalue="" checked="false"
                   label="Disable RT prediction"
                   help="When using the predictor, skip retention time predictions."/>
            <param name="duplicate_proteins" type="boolean" truevalue="--duplicate-proteins" falsevalue="" checked="false"
                   label="Allow duplicate protein IDs"
                   help="DIA-NN normally skips repeated entries with the same protein ID in a FASTA database. This allows duplicates."/>
            <param name="exact_fdr" type="boolean" truevalue="--exact-fdr" falsevalue="" checked="false"
                   label="Disable approximate FDR"
                   help="Use exact FDR (slightly slower) instead of approximate parametric modeling."/>
            <param name="force_swissprot" type="boolean" truevalue="--force-swissprot" falsevalue="" checked="false"
                   label="Only SwissProt sequences"
                   help="Discard any non-sp| entries from the FASTA(s)."/>
            <param name="full_unimod" type="boolean" truevalue="--full-unimod" falsevalue="" checked="false"
                   label="Full UniMod DB"
                   help="Load the entire UniMod modifications database (disables automatic name conversion)."/>
            <param name="gen_fr_restriction" type="boolean" truevalue="--gen-fr-restriction" falsevalue="" checked="false"
                   label="Generate fragment exclusion info (--gen-fr-restriction)"
                   help="Annotate library with fragment exclusion info based on interferences in the actual DIA runs."/>
            <param name="global_mass_cal" type="boolean" truevalue="--global-mass-cal" falsevalue="" checked="false"
                   label="Disable RT-dependent mass calibration"
                   help="Only apply global mass calibration, ignoring the usual RT-dependence. (--global-mass-cal)"/>
            <param name="il_eq" type="boolean" truevalue="--il-eq" falsevalue="" checked="false"
                   label="I/L equivalence"
                   help="When reannotating library with FASTA, consider isoleucine and leucine the same."/>
            <param name="individual_mass_acc" type="boolean" truevalue="--individual-mass-acc" falsevalue="" checked="false"
                   label="Per-run mass accuracy (--individual-mass-acc)"
                   help="Automatically determine mass accuracy for each run separately if set to auto."/>
            <param name="individual_windows" type="boolean" truevalue="--individual-windows" falsevalue="" checked="false"
                   label="Per-run scan window (--individual-windows)"
                   help="Determine the MS2 extraction window automatically for each run separately."/>
            <param name="no_isotopes" type="boolean" truevalue="--no-isotopes" falsevalue="" checked="false"
                   label="Skip heavy isotopologues"
                   help="Do not extract MS1/fragment chromatograms for heavy isotopologues."/>
            <param name="regular_swath" type="boolean" truevalue="--regular-swath" falsevalue="" checked="false"
                   label="Force regular SWATH mode"
                   help="Treat all runs as if they are not scanning SWATH (override auto-detection)."/>
            <param name="scanning_swath" type="boolean" truevalue="--scanning-swath" falsevalue="" checked="false"
                   label="Force scanning SWATH mode"
                   help="Treat all runs as scanning SWATH data (override auto-detection)."/>
            <param name="semi" type="boolean" truevalue="--semi" falsevalue="" checked="false"
                   label="Semi-specific reannotation"
                   help="When reannotating library peptides in FASTA, allow one non-specific cleavage."/>
            <param name="species_genes" type="boolean" truevalue="--species-genes" falsevalue="" checked="false"
                   label="Append organism ID to gene names"
                   help="Useful in multi-species experiments for distinguishing gene names. Works with UniProt."/>
            <param name="tims_skip_errors" type="boolean" truevalue="--tims-skip-errors" falsevalue="" checked="false"
                   label="Ignore timsTOF load errors"
                   help="Continue processing dia-PASEF data even if some frames or scans fail to load."/>
            <param name="cont_quant_exclude" type="text" optional="true"
                   label="Exclude peptides with tagged proteins from normalization (--cont-quant-exclude)"
                   help="Peptides corresponding to protein sequence IDs tagged with the specified [tag] will be excluded from normalization,
                         as well as from quantification of protein groups that do not include proteins with that tag." />

            <!-- Decoy generation parameters -->
            <param name="dg_keep_nterm" type="integer" min="0" optional="true"
                   label="Do not change first N residues when generating decoys (--dg-keep-nterm)"
                   help="Default is 1." />
            <param name="dg_keep_cterm" type="integer" min="0" optional="true"
                   label="Do not change last N residues when generating decoys (--dg-keep-cterm)"
                   help="Default is 1." />
            <param name="dg_min_shuffle" type="float" min="0" optional="true"
                   label="Min shuffle shift in decoy generation (--dg-min-shuffle)"
                   help="Aim for any fragment mass shift introduced by shuffling to exceed this in absolute value. Default 5.0" />
            <param name="dg_min_mut" type="float" min="0" optional="true"
                   label="Min mutation shift in decoy generation (--dg-min-mut)"
                   help="Aim for the precursor mass shift (mutation) to be at least this in absolute value. Default 15.0" />
            <param name="dg_max_mut" type="float" min="0" optional="true"
                   label="Max mutation shift in decoy generation (--dg-max-mut)"
                   help="Aim for the precursor mass shift to not exceed this in absolute value. Default 50.0" />

            <param name="dl_no_fr" type="boolean" truevalue="--dl-no-fr" falsevalue="" checked="false"
                   label="Disable fragment intensity prediction (--dl-no-fr)"
                   help="When using the deep learning predictor, skip fragment intensity prediction." />
            <param name="export_quant" type="boolean" truevalue="--export-quant" falsevalue="" checked="false"
                   label="Export fragment quantities to report (--export-quant)"
                   help="Adds fragment quantities, fragment IDs, and quality info to the .parquet output." />
            <param name="ext_string" type="text" optional="true"
                   label="Append suffix to each run file (--ext)"
                   help="Adds a string to the end of each run's filename, e.g. '_rep1'." />
            <param name="ids_to_names" type="boolean" truevalue="--ids-to-names" falsevalue="" checked="false"
                   label="Use protein IDs as names and genes (--ids-to-names)"
                   help="Protein sequence IDs will also be used as protein names and genes, ignoring any actual protein/genes in the DB." />
            <param name="full_profiling" type="boolean" truevalue="--full-profiling" falsevalue="" checked="false"
                   label="Full profiling (--full-profiling)"
                   help="Enable using empirical spectra for empirical library generation." />
            <param name="id_profiling" type="boolean" truevalue="--id-profiling" falsevalue="" checked="false"
                   label="IDs profiling (--id-profiling)"
                   help="Set the empirical library generation mode to IDs-based profiling." />
            <param name="peak_boundary" type="float" min="0" optional="true"
                   label="Peak boundary factor (--peak-boundary)"
                   help="If the signal decays below its max / X, that is considered the boundary of the elution peak. Affects start/stop RT." />
            <param name="min_cal" type="integer" min="0" optional="true"
                   label="Minimum # of IDs to use for mass calibration (--min-cal)"
                   help="Provide a guidance for the minimal count of IDs for mass calibration." />
            <param name="min_class" type="integer" min="0" optional="true"
                   label="Minimum # of IDs for linear classifier training (--min-class)"
                   help="Provide a guidance for the minimal count of IDs for linear classifier training." />
            <param name="min_corr" type="float" min="0" optional="true"
                   label="Minimum correlation score (--min-corr)"
                   help="Forces DIA-NN to only consider peak group candidates with correlation >= this value." />
            <param name="no_fragmentation" type="boolean" truevalue="--no-fragmentation" falsevalue="" checked="false"
                   label="Exclude all library fragments (--no-fragmentation)"
                   help="DIA-NN will ignore any fragments not explicitly in the spectral library." />
            <param name="no_ms1" type="boolean" truevalue="--no-ms1" falsevalue="" checked="false"
                   label="Skip MS1 data (--no-ms1)"
                   help="Disable MS1-level extraction/analysis (use only MS2 for ident/quant)." />
            <param name="no_peptidoforms" type="boolean" truevalue="--no-peptidoforms" falsevalue="" checked="false"
                   label="Disable peptidoform confidence scoring (--no-peptidoforms)"
                   help="Forcibly disable peptidoform confidence scoring (not recommended if you have variable mods)." />
            <param name="no_quant_files" type="boolean" truevalue="--no-quant-files" falsevalue="" checked="false"
                   label="Do not save .quant files (--no-quant-files)"
                   help="Store .quant data in memory only, do not write them to disk." />
            <param name="no_rt_norm" type="boolean" truevalue="--no-rt-norm" falsevalue="" checked="false"
                   label="Disable RT-dependent normalization (--no-rt-norm)"
                   help="Equivalent to enabling global or no normalization without the RT dimension." />
            <param name="predict_n_frag" type="integer" min="1" optional="true"
                   label="Max fragments for DL predictor (--predict-n-frag)"
                   help="Specifies the maximum number of fragments predicted by the deep learning predictor (default 12)." />
            <param name="prefix_string" type="text" optional="true"
                   label="Add prefix to run filenames (--prefix)"
                   help="Insert a string at the beginning of each runs filename, e.g. 'rep1_'." />
            <param name="pr_filter" type="data" format="txt" optional="true"
                   label="Precursor filter file (--pr-filter)"
                   help="Text file containing a list of precursor IDs (Precursor.Id format). Only those are kept." />

            <!-- quant-acc / quant-no-ms1 / quant-ori-names / quant-params -->
            <param name="quant_acc" type="float" min="0" max="1" optional="true"
                   label="QuantUMS precision-accuracy balance (--quant-acc)"
                   help="Value between 0-1. Tuning the ratio of precision vs accuracy." />
            <param name="quant_no_ms1" type="boolean" truevalue="--quant-no-ms1" falsevalue="" checked="false"
                   label="QuantUMS: do not use recorded MS1 (--quant-no-ms1)"
                   help="Instruct QuantUMS not to use the recorded MS1 intensities." />
            <param name="quant_ori_names" type="boolean" truevalue="--quant-ori-names" falsevalue="" checked="false"
                   label="Quant files keep original run names (--quant-ori-names)"
                   help=".quant files will retain original raw filenames, convenient for certain manipulations." />
            <param name="quant_params" type="text" optional="true"
                   label="Use existing QuantUMS parameters (--quant-params)"
                   help="Path to previously obtained QuantUMS parameter file. Format: [params]." />

            <!-- tims-min-int, tims-ms1-cycle -->
            <param name="tims_min_int" type="integer" min="0" optional="true"
                   label="Minimum intensity for timsTOF (--tims-min-int)"
                   help="Minimum ion count intensity to consider when loading timsTOF data." />
            <param name="tims_ms1_cycle" type="integer" min="1" optional="true"
                   label="Merge MS/MS across N cycles for timsTOF (--tims-ms1-cycle)"
                   help="For slice/scanning timsTOF, merges MS/MS from N consecutive cycles each defined by an MS1 scan." />

            <param name="tokens_file" type="data" format="txt" optional="true"
                   label="Tokens file (--tokens)"
                   help="Text file mapping modified residues/N-termini to 0-255 ints for the deep learning predictor." />
            <param name="top_n" type="integer" min="1" value="1"
                   label="Top N for protein quantification (--top)"
                   help="Default is 1, i.e. top-1 based quant." />

            <!-- tune-im, tune-rt, tune-lib, tune-lr, tune-restrict-layers -->
            <param name="tune_im" type="boolean" truevalue="--tune-im" falsevalue="" checked="false"
                   label="Tune IM predictor (--tune-im)"
                   help="Fine-tune the IM deep learning model. Requires --tune-lib." />
            <param name="tune_rt" type="boolean" truevalue="--tune-rt" falsevalue="" checked="false"
                   label="Tune RT predictor (--tune-rt)"
                   help="Fine-tune the RT deep learning model. Requires --tune-lib." />
            <param name="tune_lib" type="data" format="tsv,speclib,parquet,txt,csv" optional="true"
                   label="Library for fine-tuning (--tune-lib)"
                   help="A small library used for fine-tuning. May require additional declared mods." />
            <param name="tune_lr" type="float" min="1e-7" max="1e-1" value="0.00001" optional="true"
                   label="Fine-tuning learning rate (--tune-lr)"
                   help="Default 0.00001." />
            <param name="tune_restrict_layers" type="boolean" truevalue="--tune-restrict-layers" falsevalue="" checked="false"
                   label="Keep RNN layer weights fixed (--tune-restrict-layers)"
                   help="When fine-tuning, do not adjust weights of the RNN layers." />
        </section>

        <!-- ========== Output Options ========== -->
        <section name="output_options" expanded="true" title="Output / Reporting">
            <param name="no_main_report" type="boolean" truevalue="--no-main-report" falsevalue="" checked="false"
                   label="Skip main report (report.tsv)"
                   help="Do not produce the main .tsv report file."/>
            <param name="individual_reports" type="boolean" truevalue="--individual-reports" falsevalue="" checked="false"
                   label="Per-run output reports (--individual-reports)"
                   help="Produce a separate main report file for each run."/>
            <param name="no_stats" type="boolean" truevalue="--no-stats" falsevalue="" checked="false"
                   label="Skip stats file"
                   help="Do not produce the stats file (report.stats.tsv)."/>
            <param name="compact_report" type="boolean" truevalue="--compact-report" falsevalue="" checked="false"
                   label="Compact main report"
                   help="Produce a smaller main report with fewer columns."/>
            <param name="matrices" type="boolean" truevalue="--matrices" falsevalue="" checked="true"
                   label="Output quantity matrices (--matrices)"
                   help="Produce protein, peptide, and precursor quantity matrix files."/>
            <param name="report_decoys" type="boolean" truevalue="--report-decoys" falsevalue="" checked="false"
                   label="Save decoy PSMs to main report (--report-decoys)"
                   help="Include decoy PSM entries in the main .parquet file." />
            <param name="matrix_ch_qvalue" type="float" min="0" optional="true"
                   label="Channel q-value threshold (--matrix-ch-qvalue)"
                   help="Filter channels in the matrices by this channel-level q-value."/>
            <param name="qvalue" type="float" min="0" value="0.01"
                   label="Global q-value threshold (--qvalue)"
                   help="Global precursor-level q-value cutoff for reporting. Default is 0.01."/>
            <param name="matrix_tr_qvalue" type="float" min="0" optional="true"
                   label="Translated q-value threshold (--matrix-qvalue)"
                   help="If set, filter by 'translated q-value' in matrix output."/>
            <param name="matrix_spec_q" type="boolean" truevalue="--matrix-spec-q" falsevalue="" checked="false"
                   label="Run-specific protein q-value filtering"
                   help="Apply per-run protein q-value filters in addition to global filtering for matrix outputs."/>
            <param name="report_lib_info" type="boolean" truevalue="--report-lib-info" falsevalue="" checked="false"
                   label="Include library info in main report (--report-lib-info)"
                   help="Adds extra library columns (precursor/fragment data) to the main .tsv output."/>
            <param name="vis" type="text" optional="true"
                   label="Extract and save chromatograms (--vis)"
                   help="Save chromatograms near the apex for identified PSMs. Provide a numeric range or a list of sequences."/>
            <param name="verbose" type="integer" min="0" max="4" value="1"
                   label="Verbosity level (--verbose)"
                   help="0=errors only, up to 4=debug-level messages."/>
        </section>
    </inputs>
    <outputs>
        <data format="tabular" name="output_report" label="${tool.name} on ${on_string}: report.tsv">
            <filter>input['f'] != None and output_options['no_main_report'] == False</filter>
        </data>
        <data format="data" name="output_report_parquet" label="${tool.name} on ${on_string}: report.parquet">
            <filter>input['f'] != None</filter>
        </data>
        <data format="data" name="output_report_pred_speclib" label="${tool.name} on ${on_string}: report-lib.predicted.speclib">
            <filter>input['spectral_lib_options']['gen_spec_lib'] == True</filter>
        </data>
    </outputs>
    <tests>
        <!-- test for default run -->
        <test expect_num_outputs="4">
            <section name="input">
                <param name="f" value="small-peakpicking-cwt-allMS.mzML" />
                <section name="spectral_lib_options">
                    <param name="gen_spec_lib" value="True"/>
                    <param name="predictor" value="True"/>
                </section>
                <section name="fasta_db_options">
                    <param name="fasta" value="bsa.fasta"/>
                    <param name="fasta_search" value="True"/>
                </section>
            </section>
            <output name="output_report" file="report.tsv">
                <assert_contents>
                    <has_text text="PG.Normalised"/>
                </assert_contents>
            </output>
            <!-- <output name="output_report_parquet" file="report.parquet" compare="sim_size" delta="100"/> -->
            <output name="output_report_pred_speclib" file="report-lib.predicted.speclib" compare="sim_size" delta="100"/>
        </test>
        <!-- test for multiple fastas -->
        <test expect_num_outputs="1">
            <section name="input">
                <param name="f" value="small-peakpicking-cwt-allMS.mzML" />
                <section name="fasta_db_options">
                    <param name="fasta" value="bsa.fasta,bsa2.fasta"/>
                    <param name="fasta_search" value="True"/>
                </section>
            </section>
            <output name="output_report" file="report.tsv">
                <assert_contents>
                    <has_text text="PG.Normalised"/>
                </assert_contents>
            </output>
        </test>
        <!-- test for spec library -->
        <test expect_num_outputs="1">
            <section name="input">
                <param name="f" value="small-peakpicking-cwt-allMS.mzML" />
                <section name="spectral_lib_options">
                    <param name="lib" value="report-lib.predicted.speclib"/>
                </section>
                <section name="fasta_db_options">
                    <param name="fasta" value="bsa.fasta,bsa2.fasta"/>
                    <param name="fasta_search" value="True"/>
                </section>
            </section>
            <output name="output_report" file="report.tsv">
                <assert_contents>
                    <has_text text="PG.Normalised"/>
                </assert_contents>
            </output>
        </test>
        <!-- test for Bruker data -->
<!--        <test expect_num_outputs="2">-->
<!--            <section name="input">-->
<!--                <param name="f" value="ThyroglobMRM000003.d.tar" />-->
<!--                <section name="spectral_lib_options">-->
<!--                    <param name="gen_spec_lib" value="True"/>-->
<!--                    <param name="predictor" value="True"/>-->
<!--                </section>-->
<!--                <section name="fasta_db_options">-->
<!--                    <param name="fasta" value="bsa.fasta"/>-->
<!--                    <param name="fasta_search" value="True"/>-->
<!--                </section>-->
<!--            </section>-->
<!--            <output name="output_report" file="bruker-report.tsv">-->
<!--                <assert_contents>-->
<!--                    <has_text text="PG.Normalised"/>-->
<!--                </assert_contents>-->
<!--            </output>-->
<!--            <output name="output_report_lib" file="bruker-report-lib.tsv">-->
<!--                <assert_contents>-->
<!--                    <has_text text="PrecursorMz"/>-->
<!--                </assert_contents>-->
<!--            </output>-->
<!--        </test>-->
    </tests>
    <help>
        <![CDATA[
            **DIA-NN - a universal software for data-independent acquisition (DIA) proteomics data processing by Demichev, Ralser and Lilley labs.**

            In 2018, DIA-NN opened a new chapter in proteomics, introducing a number of algorithms which enabled reliable, robust and quantitatively accurate large-scale experiments using high-throughput methods.


            *DIA-NN is built on the following principles:*

                - Reliability achieved via stringent statistical control
                - Robustness achieved via flexible modelling of the data and automatic parameter selection
                - Reproducibility promoted by thorough recording of all analysis steps
                - Ease of use: high degree of automation, an analysis can be set up in several mouse clicks, no bioinformatics expertise required
                - Powerful tuning options to enable unconventional experiments
                - Scalability and speed: up to 1000 mass spec runs processed per hour

            *Raw data formats*

            Formats supported: Sciex .wiff, Bruker .d, Thermo .raw, .mzML and .dia (format used by DIA-NN to store spectra). Conversion from any supported format to .dia is possible. When running on Linux (native builds, not Wine), only .d, .mzML, and .dia data are supported.

            For .wiff support, download and install ProteoWizard - choose the version (64-bit) that supports "vendor files"). Then copy all files with 'Clearcore' or 'Sciex' in their name (these will be .dll files) from the ProteoWizard folder to the DIA-NN installation folder (the one which contains diann.exe, DIA-NN.exe and a bunch of other files).

            Reading Thermo .raw files requires Thermo MS File Reader to be installed. It is essential to use specifically the version by the link above (3.0 SP3).

            .mzML files should be centroided and contain data as spectra (e.g. SWATH) and not chromatograms.

            *Spectral library formats*

            DIA-NN supports comma-separated (.csv) or tab-separated (.tsv, .xls or .txt), .speclib (compact format used by DIA-NN), .sptxt (SpectraST, experimental [not in Galaxy]) and .msp (NIST, experimental [not in Galaxy]) library files. Important: the library must not contain non-fragmented precursor ions as 'fragments': each fragment ion must actually be produced by the peptide backbone fragmentation.

            *Library-free search*

            DIA-NN has a very advanced library-free module, which is, for certain types of experiments, better than using a high quality project-specific spectral library. In general, the following makes library-free search perform better in comparison to spectral libraries (while the opposite favours spectral libraries):

                - high peptide numbers detectable per run
                - heterogeneous data (e.g. cancer tissue samples are quite heterogeneous, while replicate injections of the same sample are not)
                - long chromatographic gradients as well as good separation of peptides in the ion mobility dimension
                - large dataset (although processing a large dataset in library-free mode might take time)

            Please note that in 99% of cases it is essential that MBR is enabled for a quantitative library-free analysis. It gets activated by default when using the DIA-NN GUI.

            For most experiments it does indeed make sense to try library-free search. For medium and large-scale experiments it might make sense to first try library-free analysis of a subset of the data, to see whether the performance is OK (on the whole dataset it will typically be a lot better, so no need to be too stringent here). Ourselves we also often perform a quick preliminary QC assessment of the experiment using some public library.

            It is often convenient to perform library-free analysis in two steps: by first creating an in silico-predicted spectral library from the sequence database, and then analysing with this library.

            For more information, visit https://github.com/vdemichev/DiaNN
        ]]>
    </help>
    <citations>
        <citation type="doi">10.1038/s41592-019-0638-x</citation>
        <citation type="doi">10.1038/s41467-021-25454-1</citation>
        <citation type="doi">10.1038/s41467-022-31492-0</citation>
        <citation type="doi">10.1038/s41587-022-01389-w</citation>
        <citation type="doi">10.1101/2023.06.20.545604v1</citation>
        <citation type="doi">10.1101/2022.10.31.514544v1</citation>
    </citations>
</tool>
